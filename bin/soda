#!/bin/bash

usage()
{
    local cmd=$(basename $0)
    cat << EOF
usage:
    $cmd init  <work> [lang]
    $cmd new   <lang>
    $cmd run   <lang> [-i <tag>]
    $cmd clean <lang>
    $cmd call  <lang> [options]
EOF
    exit 1
}

self_dir=$(cd $(dirname $0) && pwd)
soda_dir=$(dirname $self_dir)
framework_dir=$soda_dir/framework
export SODA_FRAMEWORK_DIR=$framework_dir
project_file=soda.prj.yml

cmd=$1

function init_work()
{
    local work=$1
    [ -e $project_file ] && { echo "$project_file already exists"; exit 2; }
    cat >$project_file << eof
soda:
  version: 2.0.1
  work_name: $work
eof
    echo $project_file generated
}

function get_work_name()
{
    python3 << eof
import yaml
with open("$project_file", "rt") as fp:
    config = yaml.load(fp, Loader=yaml.FullLoader)
    print(config['soda']['work_name'])
eof
}

function check_sdk()
{
    ilang=$1
    [ -z "$ilang" ] && usage
    sdk_dir=$framework_dir/$ilang
    [ -e $sdk_dir ] || { echo "language '$ilang' not supported"; exit 3; }
}

function execute()
{
    local work=$1
    local ilang=$2
    export PYTHONPATH="$framework_dir/python/src:$PYTHONPATH"
    runner=soda.engine.main
    python3 -m $runner $work --script "$framework_dir/$ilang/work.sh"
}

function create_work()
{
    ilang=$1
    check_sdk $ilang
    work=$(get_work_name)
    [ -z $work ] && exit
    $framework_dir/$ilang/work.sh new $work || exit
    lowcase=$(echo "$work" | awk '{print tolower($0)}')
    test_file=${lowcase}.input
    [ -e $test_file ] || cat >$test_file <<EOF
#@format=case

# number of arguments
# @args=N

# test case directive, '@case' is required, all key value settings are optional
# @case skip=false timeout=10 tag=
#
# content:
#   format 1: @include=FILEPATH
#   format 2:
#       Input: nums = [1,2,3,1], k = 3, t = 0
#       Output: true
#   format 3:
#       [1,2,3,1]
#       3
#       0
#       true

EOF
}

function parse_run_args()
{
    local args=("$@")
    local i=0
    while [ $i -lt "${#args[@]}" ]; do
        local t=${args[$i]}
        if [ "$t" == "-i" ]; then
            ((i++))
            tags=${args[$i]}
        elif [ "$t" == "--clean" ]; then
            force_rebuild=yes
        elif [ "$t" == "--remote" ]; then
            remote_mode=yes
        fi
        ((i++))
    done
}

function trans_lang_name()
{
    local name=$1
    case $name in
        cs)
            name=csharp
            ;;
        py)
            name=python
            ;;
        *)
            ;;
    esac
    echo $name
}

tags=
force_rebuild=no
remote_mode=no

# get_script()
# {
#     local lang=$1
#     if [ $lang == "cpp" ]; then
#         soda_dir=$(dirname $self_dir)
#         echo "docker run -i --rm --user $USER -v $soda_dir:/soda -v $(pwd):/task -w /task soda-cpp /soda/framework/$lang/work.sh"
#     else
#         echo "$framework_dir/$lang/work.sh"
#     fi
# }

case $cmd in 
    init)
        work=$2
        [ -z "$work" ] && usage
        init_work $work
        [ -z $3 ] || create_work $(trans_lang_name "$3")
        ;;
    new)
        ilang=$(trans_lang_name $2)
        [ -z "$ilang" ] && usage
        create_work $ilang
        ;;
    run)
        # prepare sdk
        ilang=$(trans_lang_name $2)
        check_sdk $ilang
        script=$framework_dir/$ilang/work.sh
        work=$(get_work_name)
        # parse command line options
        parse_run_args "$@"
        # build executable
        [ "$force_rebuild" == "yes" ] && $script clean $work
        $script make $work || exit 
        # run test cases
        export PYTHONPATH="$framework_dir/python/src:$PYTHONPATH"
        runner=soda.engine.main
        commandStr="$script run $work"
        if [ "$remote_mode" == "yes" ]; then
            commandStr="$commandStr --remote"
            $script remote-setup || exit
        fi
        [ -z "$tags" ] || tag_options="--tags $tags"
        python3 -m $runner $work --command "$commandStr" $tag_options
        ;;
    clean)
        ilang=$(trans_lang_name $2)
        check_sdk $ilang
        script=$framework_dir/$ilang/work.sh
        work=$(get_work_name)
        $script clean $work
        ;;
    call)
        ilang=$(trans_lang_name $2)
        check_sdk $ilang
        script=$framework_dir/$ilang/work.sh
        shift; shift;
        $script "$@"
        ;;
    *)
        usage
        ;;
esac
